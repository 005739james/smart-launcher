<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
        <title>SMART App Launcher</title>

        <link href="/vendor/bootstrap-3.3.6/css/bootstrap.min.css" rel="stylesheet">
        <link href="/vendor/bootstrap-3.3.6/css/bootstrap-theme.min.css" rel="stylesheet">
        <link href="/blue-nav.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
            <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->
    </head>
    <body>

        <div class="baner bg-warning">
            <div class="container">
                <div class="row">
                    <div class="col-xs-12 baner-message text-warning">
                        <i class="glyphicon glyphicon-info-sign"></i>
                        You can bookmark this page to save your settings! You can also email or share this URL.
                    </div>
                </div>
                <hr />
                <div class="row bottom-row">
                    <div class="col-xs-8">
                        <div class="checkbox text-muted">
                            <label>
                                <input type="checkbox" class="remember-baner"/> Don't show again
                            </label>
                        </div>
                    </div>
                    <div class="col-xs-4 text-right">
                        <button class="btn btn-primary close-baner">Close</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="navbar navbar-custom navbar-static-top">
            <div class="container-fluid">
                <div class="navbar-header">
                    <div class="pull-left" style="margin: 10px;">
                        <img src="/img/smart-bug.png" />
                    </div>
                    <a class="navbar-brand" href="#" style="white-space:nowrap;text-overflow:ellipsis;text-shadow:none">
                        SMART App Launcher
                    </a>
                </div>
            </div>
        </div>

        <div class="container" id="loading">
            <div class="row">
                <div class="col-xs-12" style="text-align: center;margin-top:50px;">
                    <img src="/img/ajax-loader.gif"/>
                </div>
            </div>
        </div>
        <div class="container" id="content" style="display:none;">
            <div class="panel panel-info alert-info sandbox-panel" style="display:none">
                <div class="panel-heading">
                    <b class="text-primary">My Sandbox</b>
                </div>
                <div class="panel-body navbar-default" style="padding-bottom: 0">
                    <div class="form-group col-sm-6">
                        <label for="sb">Name</label>
                        <input id="sb" class="form-control">
                        <p class="help-block small">Randomly generated name, reuse a previous name to share data between launch simulations</p>
                    </div>
                
                    <div class="form-group col-sm-6">
                        <label for="fhir-version-1">Version</label>
                        <select id="fhir-version-1" class="form-control fhir-version"></select>
                        <p class="help-block small">&nbsp;</p>
                    </div>

                    <br clear="all" />
                    <div class="form-group col-sm-6">
                        <p><label>Also include read access to these pre-defined datasets</label></p>
                        <div class="fhir-tags"></div>
                    </div>

                    <div class="form-group col-sm-6">
                        <a href="#" target="_blank" class="btn btn-sm btn-default pull-right open-url-preview" style="padding: 2px 3em;margin: -5px 0 0">Test</a>
                        <label for="open-url">
                            Open FHIR Endpoint URL
                        </label>
                        <div class="alert alert-info" style="margin: 0">
                            <div>
                                <a class="form-control-static open-url"></a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel panel-default">
                <div class="panel-heading">
                    <b class="text-primary">
                        <i class="glyphicon glyphicon-cog"></i> App Launch Options
                    </b>
                </div>
                <div class="panel-body navbar-default">
                
                    <!-- Launch Type ======================================= -->
                    <div class="form-group col-sm-6">
                        <label for="launch-type">Launch Type</label>
                        <div class="radio" style="margin-top: 0">
                            <label>
                                <input type="radio" name="launch-type" id="launch-ehr" checked>
                                Provider EHR Launch
                                <span class="text-muted small">(user opens the app from within an EHR)</span>
                            </label>
                            <div style="margin: 5px 0 10px">
                                <label id="sim-ehr-label">
                                    <input type="checkbox" id="sim-ehr" checked> Simulate launch within the EHR user interface
                                </label>
                            </div>
                        </div>
                        <div class="radio">
                            <label>
                                <input type="radio" name="launch-type" id="launch-prov">
                                Provider Standalone Launch 
                                <span class="text-muted small">(practitioner opens the app directly and connects to FHIR)</span>
                            </label>
                        </div>
                        <div class="radio">
                            <label>
                                <input type="radio" name="launch-type" id="launch-pt">
                                Patient Standalone Launch 
                                <span class="text-muted small">(patient opens the app directly and connects to FHIR)</span>
                            </label>
                        </div>
                    </div>

                    <!-- FHIR Version ====================================== -->
                    <div class="form-group col-sm-6">
                        <label for="fhir-version-2">FHIR Version</label>
                        <select id="fhir-version-2" class="form-control fhir-version"></select>
                        <div class="small" style="border-bottom: 1px dotted #DDD;line-height:26px;margin: 4px 0 0px">
                            <a class="pull-right btn btn-info btn-xs open-url-preview" href="#" target="_blank">Test</a>
                            <span class="text-muted"> FHIR Base URL: </b>
                            <a class="form-control-static open-url text-info"></a>
                            </i>
                        </div>
                    </div>
                    <br clear="all" class="launch launch-ehr launch-prov hidden-xs show-if-no-sandboxes"/>

                    <!-- Patient =========================================== -->
                    <div class="form-group col-sm-6 launch launch-ehr launch-prov">
                        <label for="patient">Patient(s)</label>
                        <div class="input-group">
                            <input id="patient" class="form-control" value="" placeholder="Patient ID">
                            <span class="input-group-btn">
                                <button class="btn btn-default" type="button" id="patient-select-button"><span class="caret"></span></button>
                            </span>
                        </div>
                        <p class="help-block small">
                            Simulates the active patient in EHR when app is launched.
                            A patient picker will be displayed as part of the launch
                            flow if no Patient ID is entered and a <code>patient</code>
                            or <code>launch/patient</code> scope is specified in your
                            app, or if multiple comma delimited Patient IDs are specified.
                        </p>
                    </div>

                    <!-- Provider ========================================== -->
                    <div class="form-group col-sm-6 launch launch-ehr launch-prov">
                        <label for="user">Provider(s)</label>
                        <input id="provider" class="form-control" placeholder="Provider ID">
                        <p class="help-block small">
                            Simulates user who is launching the app. Only required when
                            <code>profile</code> and <code>openid</code> scopes are
                            specified. If you select multiple providers you will have
                            to pick one of them on the login page.
                        </p>
                    </div>
                    
                    <!-- Patient =========================================== -->
                    <div class="form-group col-sm-6 launch launch-pt">
                        <label for="user">Patient(s)</label>
                        <div class="input-group">
                            <input id="user-pt" class="form-control" value="smart-967332" placeholder="Patient ID">
                            <span class="input-group-btn">
                                <button class="btn btn-default" id="user-pt-select" type="button"><span class="caret"></span></button>
                            </span>
                        </div>
                        <p class="help-block small">
                            Simulates the user who is launching the app. A patient picker
                            will be displayed as part of the launch flow if no Patient ID
                            is entered and a <code>patient</code> or <code>launch/patient</code>
                            scope is specified in your app, or if multiple comma delimited
                            Patient IDs are specified.
                        </p>
                    </div>

                    <div class="form-group col-xs-12">
                        <label class="text-warning">Advanced</label>
                        <hr class="solid fg-warning"/>
                        <div class="row">
                            <div class="col-sm-6">
                                <label class="launch launch-ehr">
                                    Active Encounter in EHR <span class="text-muted normal-weight">(if the app requests a <code>launch</code> scope)</span>
                                </label>
                                <div class="radio launch launch-ehr" style="margin-top: 0">
                                    <label>
                                        <input type="radio" name="select-encounter" id="select-encounter" checked> Show encounter selector
                                    </label><br/>
                                    <label>
                                        <input type="radio" name="select-encounter"> Use the patient's most recent encounter if available
                                    </label>
                                </div>
                                <label class="launch launch-prov launch-pt">
                                    Auth Flow
                                </label>
                                <div class="launch launch-prov">
                                    <div class="checkbox" style="margin-top: 0">
                                        <label><input type="checkbox" id="prov-skip-login" checked>Skip provider login screen <span class="text-muted normal-weight small">(will launch as if the Provider Id above had logged in)</span></label>
                                    </div>
                                    <div class="checkbox">
                                        <label><input type="checkbox" id="prov-skip-auth" checked>Skip app authorization screen</label>
                                    </div>
                                </div>
                                <div class="launch launch-pt">
                                    <div class="checkbox" style="margin-top: 0">
                                        <label><input type="checkbox" id="pt-skip-login">Skip patient login screen <span class="text-muted normal-weight small">(will launch as if the Patient Id above had logged in)</span></label>
                                    </div>
                                    <div class="checkbox">
                                        <label><input type="checkbox" id="pt-skip-auth" checked>Skip app authorization screen</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <label for="sb">Simulate Authentication Error for Testing</label>
                                <select id="auth-error" class="form-control">
                                    <option value="">None</option>
                                    <option value="auth_invalid_client_id">Authorize - Invalid Client Id</option>
                                    <option value="auth_invalid_redirect_uri">Authorize - Invalid Redirect Url</option>
                                    <option value="auth_invalid_scope">Authorize - Invalid Scope</option>
                                    <option value="auth_invalid_client_secret">Token - invalid client secret (for confidential apps)</option>
                                    <option value="token_invalid_token">Token - Invalid Token</option>
                                    <option value="request_invalid_token">Request - Invalid Token</option>	
                                    <option value="request_expired_token">Request - Expired Token</option>	
                                </select>
                                <br/>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel panel-success alert-success">
                <div class="panel-heading">
                    <b class="text-success">
                        <i class="glyphicon glyphicon-new-window"></i> Launch
                    </b>
                </div>
                <div class="panel-body list-group-item-warning text-success" style="box-shadow: 0 -1px 0 0 rgba(0, 0, 0, 0.06) inset, 0 1px 0 0 #b2dba1 inset">
                    <h3 class="glyphicon glyphicon-info-sign pull-left" style="margin:0"></h3>
                    <ul style="margin: 0 0 0 10px" class="text-muted">
                        <li>
                            <span class="label label-default">client_id</span>
                            <small>The app's <code>client_id</code> is not validated on the SMART test server,
                            so any text string will work. You can use the error simulator to
                            simulate the server response to an invalid <code>client_id</code>.</small>
                        </li>
                        <li>
                            <span class="label label-default">client_secret</span>
                            <small>The app's <code>client_secret</code> is not validated on the SMART test server,
                            so any secret will work. If provided, the <code>Authorization</code> header must conform
                            to the standart format (<a target="_blank" href="http://docs.smarthealthit.org/authorization/basic-auth-example/"
                            >Example</a>). You can also use the error simulator to simulate the server response to an invalid
                            <code>client_secret</code>.
                            </small>
                        </li>
                    </ul>
                </div>
                <div class="panel-body navbar-default" style="border-radius: 0 0 4px 4px">
                    <div class="form-group col-xs-12">
                        <label for="launch-url" class="launch launch-ehr">App Launch URL <span class="text-muted normal-weight">(required)</span></label>
                        <div class="input-group launch launch-ehr">
                            <input id="launch-url" class="form-control" placeholder="Launch URL">
                            <span class="input-group-btn">
                                <a id="ehr-launch-url" href="#" target="_blank" class="btn btn-success">Launch App!</a>
                            </span>
                        </div>
                        <p class="help-block small launch launch-ehr">
                            Web address that will initialize the SMART session (typically the full url of your launch.html file)
                        </p>
                        <div class="launch launch-pt launch-prov">
                            <label class="">FHIR Server Url</label>
                            <textarea id="standalone-launch-url" class="form-control" readonly></textarea>
                            <p class="help-block small">
                                Your app should use the URL above as base URL (and <code>aud</code> parameter) and authenticate as
                                described <a target="_blank" href="http://docs.smarthealthit.org/authorization/#standalone-launch-sequence">here</a>.
                            </p>
                        </div>
                        <div class="text-center launch launch-pt launch-prov">
                            <hr/>
                            <a class="btn btn-success" id="standalone-launch-url-test" target="_blank" href="#">Launch Demo App</a>
                            <br/>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <br/>

        <script src="/vendor/jquery-1.12.3.min.js"></script>
        <script src="/vendor/bootstrap-3.3.6/js/bootstrap.min.js"></script>
        <script src="/config.js"></script>
        <script src="/lib.js"></script>
        <script src="/jquery.picker.js"></script>
        <script>

            // Getters ---------------------------------------------------------
            function getFhirVersion() {
                return $(".fhir-version:visible").val() || CONFIG.fhirVersions[0].name;
            }

            function getSandboxName() {
                return CONFIG.enableSandboxes ? $("#sb").val() || "public" : "public";
            }

            function getLaunchType() {
                return $("input[name=launch-type]:checked").attr("id");
            }

            function getTags() {
                var tags = [], sb = getSandboxName();
                if (CONFIG.enableSandboxes) {
                    tags = $(".sb :checked").filter(":visible").map(
                        function () { return $(this).val() }
                    ).get();

                    if (sb) {
                        tags.unshift(sb);
                    }
                }
                return tags;
            }

            function getLaunchUrl() {
                return $.trim($("#launch-url").val());
            }

            // -----------------------------------------------------------------

            function buildForm() {

                // Build the FHIR tag checkboxes
                if (CONFIG.enableSandboxes) {
                    $(".sandbox-panel").show();
                    $("#fhir-version-2").closest(".col-sm-6").remove();
                    $(".fhir-tags").html(
                        $.map(CONFIG.fhirVersions, function(v) {
                            return $.map(v.tags, function(t) {
                                return '<div class="checkbox sb ' + v.name + '">' +
                                    '<label>' +
                                        '<input class="tag" type="checkbox" id="' + t.id + '" value="' + t.value +
                                        '"' + (t.selected ? ' checked' : '') + '>' +
                                            '<b>' + t.displayName + '</b> <small class="text-muted">(' +
                                                t.description + ')</small>' +
                                        '</label>' +
                                    '</div>';
                            }).join("");
                        }).join("")
                    );
                }

                // Build the FHIR version selector
                $(".fhir-version").html(
                    $.map(CONFIG.fhirVersions, function(v) {
                        return '<option value="' + v.name + '">' + v.displayName + '</option>';
                    }).join()
                );
            }

            function validateLaunchUrl() {
                var val = getLaunchUrl();
                var idx = val.indexOf(":");
                if (!val || idx < 1 || idx === val.length - 1) {
                    $("#ehr-launch-url").prop("disabled", true).addClass("disabled");
                    return false;
                }
                $("#ehr-launch-url").prop("disabled", false).removeClass("disabled");
                return true;
            }

            function bindEventHandlers() {

                $("input.remember-baner").on("change", function(e) {
                    e.stopPropagation();
                });

                $("#launch-url").on("change input", validateLaunchUrl);

                $(document).on("input change", "input,select", function() {
                    handleFormChange();
                });

                $("#launch-button").click( function() {
                    window.open( $("#picker-url").text() );
                });

                $("#standalone-launch-url").on("focus", function() {
                    $(this).select();
                });

                $("#patient-select-button").on("click", function() {
                    var input = $("#patient");
                    var fhirVersion = getFhirVersion();
                    if (fhirVersion == "r2") {
                        fhirVersion = "DSTU-2"
                    }
                    else if (fhirVersion == "r3") {
                        fhirVersion = "STU-3"
                    }

                    var tags = $("input:checkbox.tag:checked:visible").map(function(i, cb) {
                        return {
                            key  : cb.value,
                            label: $(cb).parent().text(),
                            selected: true
                        };
                    }).get();

                    tags.unshift({
                        key: $("#sb").val(),
                        label: "My Own Data",
                        selected: true
                    });

                    // alert(getBaseUrl() + "/fhir")
                    Lib.selectPatients(input.val(), {
                        pickerSettings: {
                            server: {
                                url : getBaseUrl() + "/fhir",
                                type: fhirVersion,
                                tags: tags,
                                conditions: []
                            },
                            hideTagSelector: true
                        }
                    }).then(sel => {
                        if (sel || sel === "") {// ignore cancel and close cases
                            input.val(sel);
                            buildUrls();
                        }
                    });
                });

                $("#user-pt-select").on("click", function() {
                    var input = $("#user-pt");
                    var fhirVersion = getFhirVersion();
                    if (fhirVersion == "r2") {
                        fhirVersion = "DSTU-2"
                    }
                    else if (fhirVersion == "r3") {
                        fhirVersion = "STU-3"
                    }

                    var tags = $("input:checkbox.tag:checked:visible").map(function(i, cb) {
                        return {
                            key  : cb.value,
                            label: $(cb).parent().text(),
                            selected: true
                        };
                    }).get();

                    tags.unshift({
                        key: $("#sb").val(),
                        label: "My Own Data",
                        selected: true
                    });
                    // console.log(tags);
                    // alert(getBaseUrl() + "/fhir")
                    Lib.selectPatients(input.val(), {
                        pickerSettings: {
                            server: {
                                url : getBaseUrl() + "/fhir",
                                type: fhirVersion,
                                tags: tags,
                                conditions: []
                            },
                            hideTagSelector: true
                        }
                    }).then(sel => {
                        if (sel || sel === "") {// ignore cancel and close cases
                            input.val(sel);
                            buildUrls();
                        }
                    });
                });

                $("#encounter").picker({
                    url: getBaseUrl() + "/fhir/Encounter",
                    multiple: true,
                    onChange: function() {
                        buildUrls();
                        Lib.formToQs();
                    }
                });

                $("#provider").picker({
                    url: function() {
                        return getBaseUrl() + "/fhir/Practitioner";
                    },
                    multiple: true,
                    onChange: function() {
                        buildUrls();
                        Lib.formToQs();
                    }
                });

                $(".fhir-tags input:checkbox, .fhir-version").on("change", function() {
                    $("#provider").val("").closest(".dropdown").find(".dropdown-menu").empty();
                    $("#patient, #user-pt").val("");
                });

                $(".close-baner").on("click", hideBaner);
            }

            function showBaner() {
                $(".baner").css({
                    height: $(".baner")[0].scrollHeight,
                    opacity: 1
                });
                setTimeout(function() {
                    $(".baner").css({ height: "auto" })
                }, 400);
            }

            function hideBaner() {
                if ($("input.remember-baner").prop("checked")) {
                    Lib.setCookie("hide-baner", "1", 730);
                }
                $(".baner").css("height", $(".baner")[0].scrollHeight);
                setTimeout(function() {
                    $(".baner").css({
                        height : 0,
                        opacity: 0
                    });
                }, 20);
            }

            function getBaseUrl() {
                var baseUrl = window.location.href.split("?")[0].replace(/index\.html/, "");
                var sandboxes = getTags();
                baseUrl += "v/" + getFhirVersion();
                if (sandboxes.length) {
                    baseUrl += "/sb/" + sandboxes.join(",");
                }
                return baseUrl;
            }

            function buildUrls() {
                // debugger;
                var baseUrl = getBaseUrl();
                var launchType = getLaunchType();
                var paramMap = {
                    "launch-ehr": [
                        [ "#launch-ehr"      , "launch_ehr"       ],
                        [ "#patient"         , "patient"          ],
                        [ "#encounter"       , "encounter"        ],
                        [ "#auth-error"      , "auth_error"       ],
                        [ "#provider"        , "provider"         ],
                        [ "#sim-ehr"         , "sim_ehr"          ],
                        [ "#select-encounter", "select_encounter" ]
                    ],
                    "launch-prov": [
                        [ "#launch-prov"     , "launch_prov"      ],
                        [ "#patient"         , "patient"          ],
                        [ "#encounter"       , "encounter"        ],
                        [ "#auth-error"      , "auth_error"       ],
                        [ "#prov-skip-login" , "skip_login"       ], 
                        [ "#prov-skip-auth"  , "skip_auth"        ], 
                        [ "#provider"        , "provider"         ]
                    ],
                    "launch-pt": [
                        [ "#launch-pt"       , "launch_pt"        ],
                        [ "#auth-error"      , "auth_error"       ],
                        [ "#pt-skip-login"   , "skip_login"       ],
                        [ "#pt-skip-auth"    , "skip_auth"        ],
                        [ "#user-pt"         , "patient"          ]
                    ]
                };

                var urlParams = {};
                $.each(paramMap[launchType], function(i, param) {
                    var val = $(param[0]).is(":checkbox,:radio") ?
                        $(param[0]).is(":checked") :
                        $(param[0]).val();
                    if (val) {
                        urlParams[param[1]] = (val === true ? "1" : val);
                    }
                });

                var openUrl       = baseUrl + "/fhir";
                var launchData    = Lib.base64UrlEncode(JSON.stringify(urlParams));
                var standaloneUrl = baseUrl + "/sim/" + launchData + "/fhir";
                var appLaunchUrl  = getLaunchUrl();
                var ehrLaunchUrl  = appLaunchUrl + "?iss=" + encodeURIComponent(openUrl) + "&launch=" + launchData;

                if (urlParams.sim_ehr) {
                    ehrLaunchUrl = "/ehr.html?app=" + encodeURIComponent(ehrLaunchUrl) +
                        "&user=" + encodeURIComponent(urlParams.provider || "") +
                        "&encounter=" + encodeURIComponent(urlParams.encounter || "");
                }

                $(".open-url").text(openUrl);
                $(".open-url-preview").attr("href", openUrl + "/metadata");
                $("#ehr-launch-url").attr("href", ehrLaunchUrl);
                $("#standalone-launch-url").text(standaloneUrl);
                
                // console.log(JSON.stringify(urlParams, null, 4))
                $("#standalone-launch-url-test").attr(
                    "href",
                    "/sample-app/index.html?aud=" + encodeURIComponent(standaloneUrl)
                );
            }

            function handleFormChange() {
                var launchType = getLaunchType();
                $(".launch").hide().filter("." + launchType).show();
                if (CONFIG.enableSandboxes) {
                    $(".sb").hide().filter(".sb." + getFhirVersion()).show();
                }
                $("#sim-ehr-label").toggleClass("disabled", launchType != "launch-ehr");
                $("#sim-ehr").prop("disabled", launchType != "launch-ehr");
                buildUrls();
                Lib.formToQs();
            }

            $(function init() {
                $("body").toggleClass("no-sandboxes", !CONFIG.enableSandboxes);
                $("#loading").hide();
                $("#content").show();
                buildForm();
                Lib.qsToForm();
                if (CONFIG.enableSandboxes && !$("#sb").val()) {
                    $("#sb").val(Lib.generateUID());
                }
                bindEventHandlers();
                if (!$("#launch-url").val()) {
                    $("#launch-url").val(location.origin + "/sample-app/launch.html");
                }
                handleFormChange();
                
                validateLaunchUrl();
                if (!Lib.getCookie("hide-baner")) {
                    showBaner();
                }
            });

        </script>
    </body>
</html>