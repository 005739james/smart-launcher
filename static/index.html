<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
		<title>SMART App Launcher</title>

		<link href="vendor/bootstrap-3.3.6/css/bootstrap.min.css" rel="stylesheet">
		<link href="blue-nav.css" rel="stylesheet">

		<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
		<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
		<!--[if lt IE 9]>
			<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
			<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
		<![endif]-->

	</head>
	<body>

		<div class="navbar navbar-custom navbar-static-top"><div class="container-fluid">
			<div class="navbar-header">
				<div class="pull-left" style="margin: 10px;">
					<img src="img/smart-bug.png" />
				</div>
				<a class="navbar-brand" href="#" style="white-space:nowrap; text-overflow:ellipsis;">
					SMART App Launcher
				</a>
			</div>
		</div></div>

		<div class="container" id="loading"><div class="row">
				<div class="col-xs-12" style="text-align: center;margin-top:50px;">
					<img src="img/ajax-loader.gif"/>
				</div>
		</div></div>
		<div class="container" id="content" style="display:none;"><div class="row">

				<div class="col-xs-12"><div class="panel panel-default">
					<div class="panel-heading">Sample Data</div>
					<div class="panel-body">
						<div class="form-group">
							<label for="fhir-version">FHIR Version</label>
							<select id="fhir-version" class="form-control">
								<option value="r2">R2 (DSTU2)</option>
								<option value="r3" selected>R3 (STU3)</option>
							</select>
						</div>

						<div class="form-group">
							<label for="sb">Read and Write to Dataset Named</label>
							<input id="sb" class="form-control" value="wyg7nz">
							<p class="help-block">Randomly generated name, reuse a previous name to share data between launch simulations</p>
							<div class="checkbox sb r2">
								<label><input type="checkbox" id="r2-smart" value="smart-8-2017" checked>Also include read access to core SMART sample patient dataset</label>
							</div>
							<div class="checkbox sb r3">
								<label><input type="checkbox" id="r3-smart" value="smart-7-2017" checked>Also include read access to core SMART sample patient dataset</label>
							</div>
							<div class="checkbox sb r3">
								<label><input type="checkbox" id="r3-synthea" value="synthea-7-2017">Also include read access to SMART Synthea sample patient dataset</label>
							</div>
							<div class="checkbox sb r3">
								<label><input type="checkbox" id="r3-pro" value="pro-7-2017">Also include read access to SMART PRO sample patient dataset</label>
							</div>
						</div>

						<div class="form-group">
							<label for="open-url">Open FHIR Endpoint URL</label>
							<p class="form-control-static" id="open-url"></p>
						</div>
					</div>
				</div></div>
	
				<div class="col-xs-12"><div class="panel panel-default">
					<div class="panel-heading">App Launch Simulation</div>
					<div class="panel-body">
					
						<div class="form-group">
							<label for="launch-type">Launch Type</label>
							<div class="radio"><label>
								<input type="radio" name="launch-type" id="launch-ehr" checked>
								Provider EHR Launch Flow (user opens the app from within an EHR)
							</label></div>
							<div class="radio"><label>
								<input type="radio" name="launch-type" id="launch-prov">
								Provider Standalone Launch Flow (practitioner opens the app directly and connects to FHIR server)
							</label></div>
							<div class="radio"><label>
								<input type="radio" name="launch-type" id="launch-pt">
								Patient Standalone Launch Flow (patient opens the app directly and connects to FHIR server)
							</label></div>

						</div>

						<div class="form-group launch launch-ehr">
							<label for="launch-url">App Launch URL (required)</label>
							<!-- <input id="launch-url" class="form-control" value="http://127.0.0.1:9090/launch.html"> -->
							<input id="launch-url" class="form-control" value="https://sb-apps.smarthealthit.org/apps/bp-centiles/launch.html">
							<p class="help-block">Web address that will initialize the SMART session (typically the full url of your launch.html file)</p>
						</div>

						<div class="form-group">
							<label for="client-id">App Client Id</label>
							<p class="form-control-static" id="client-id">my_web_app</p>
							<p class="help-block">This is not validated on the SMART test server, so any text string will work. Use the error simulator to simulate the server response to an invalid client_id.</p>
						</div>

						<div class="form-group launch launch-ehr launch-prov">
							<label for="user">Provider Id (simulates user who is launching the app)</label>
							<input id="user-prov" class="form-control" value="smart-Practitioner-71032702">
							<p class="help-block">Only required when profile and openid scopes are specified</p>
							<div class="checkbox launch launch-prov">
								<label><input type="checkbox" id="prov-skip-login" checked>Skip provider login screen (will launch as if the Provider Id above had logged in)</label>
							</div>
							<div class="checkbox launch launch-prov">
								<label><input type="checkbox" id="prov-skip-auth" checked>Skip app authorization screen</label>
							</div>
						</div>

						<div class="form-group launch launch-ehr launch-prov">
							<label for="patient">Patient Id (simulates the active patient in EHR when app is launched)</label>
							<input id="patient" class="form-control" value="">
							<p class="help-block">A patient picker will be displayed as part of the launch flow if no Patient Id is entered and a patient or launch/patient scope is specified, or if multiple comma delimited Patient Ids are specified</p>
						</div>


						<div class="form-group launch launch-ehr">
							<label for="encounter">Encounter Id (simulates the active encounter in EHR when app is launched)</label>
							<input id="encounter" class="form-control" value="">
						</div>

						<div class="form-group launch launch-pt">
							<label for="user">Patient Id (simlulates user who is launching the app)</label>
							<input id="user-pt" class="form-control" value="smart-967332">
							<p class="help-block">If no Patient Id is entered or a comma delimited Patient Ids are specified, the patient login screen will be displayed as part of the launch flow</p>
							<div class="checkbox launch launch-pt">
								<label><input type="checkbox" id="pt-skip-login">Skip patient login screen (will launch as if the Patient Id above had logged in)</label>
							</div>
							<div class="checkbox launch launch-pt">
								<label><input type="checkbox" id="pt-skip-auth"  checked>Skip app authorization screen</label>
							</div>
						</div>


						<div class="form-group">
							<label for="sb">Simulate Authentication Error for Testing (Advanced)</label>
							<select id="auth-error" class="form-control">
								<option value="">None</option>
								<option value="auth_invalid_client_id">Authorize - Invalid Client Id</option>
								<option value="auth_invalid_redirect_uri">Authorize - Invalid Redirect Url</option>
								<option value="auth_invalid_scope">Authorize - Invalid Scope</option>
								<option value="token_invalid_token">Token - Invalid Token</option>
								<option value="request_invalid_token">Request - Invalid Token</option>	
								<option value="request_expired_token">Request - Expired Token</option>	
							</select>
						</div>
					</div>
				</div></div>

				<div class="col-xs-12"><div class="panel panel-default">
					<div class="panel-heading">Launch</div>
					<div class="panel-body">
						<label for="user" class="launch launch-pt launch-prov">
							FHIR Server Url
						</label>
						<a id="ehr-launch-url" href="#" target="_blank" class="btn btn-success btn-block launch launch-ehr">Launch App!</a>
						<textarea id="standalone-launch-url" class="form-control launch launch-pt launch-prov" readonly></textarea>
					</div>
				</div></div>

		</div></div> <!-- row > container -->


		<script src="vendor/jquery-1.12.3.min.js"></script>
		<script src="vendor/bootstrap-3.3.6/js/bootstrap.min.js"></script>
		<script src="vendor/underscore-1.8.3.min.js"></script>

		<script>

			//this is temporary - should use a better algorithm to prevent conflicts
			function generateUID() {
				var firstPart = (Math.random() * 46656) | 0;
				var secondPart = (Math.random() * 46656) | 0;
				firstPart = ("000" + firstPart.toString(36)).slice(-3);
				secondPart = ("000" + secondPart.toString(36)).slice(-3);
				return firstPart + secondPart;
			}

			function qsToForm() {
				var query = ((window.location.search).substring(1) || "").split("&");
				$.each(query, function(i, param) {
					var p = param.split('=');
					var key = p[0].replace(/_/g, "-");
					var value = decodeURIComponent(p[1]);
					var target = $("#"+key);
					if (target.is(":checkbox,:radio")) {
						target.prop("checked", value === "1");
					} else {
						target.val(value);
					}
				});
				if (!$("#sb").val()) $("#sb").val(generateUID());
			}

			function formToQs() {
				var qs = {};
				$("input,select").each( function() {
					var target = $(this);
					var key = target.attr("id").replace(/-/g, "_");
					if (target.is(":checkbox")) {
						qs[key] = target.prop("checked") ? "1" : "0";
					} else if (target.is(":radio")) {
						if(target.prop("checked")) qs[key] = "1";
					} else {
						qs[key] = (target.val() || "");						
					}
				});
				var sortedQs = _.map( _.keys(qs).sort(), function(key) {
					return key + "=" + encodeURIComponent(qs[key]);
				}).join("&")
				var newUrl = window.location.href.split("?")[0] + "?" + sortedQs;
				if (window.history && newUrl != window.location.href) {
					window.history.replaceState({}, document.title, newUrl);
				}
			}

			function bindEventHandlers() {

				$("input,select").on("input change", function() {
					handleFormChange();
				});

				$("#launch-button").click( function() {
					window.open( $("#picker-url").text() );
				});

				$("#standalone-launch-url").on("focus", function() {
					$(this).select();
					$(this).mouseup(function() {
						$(this).unbind("mouseup");
						return false;
					});
				})
			}


			function buildUrls() {
				var baseUrl = window.location.href.split("?")[0].replace(/index\.html/, "");
				
				var sandboxes = $(".sb :checked").filter(":visible").map( 
					function () { return $(this).val() }
				).get();
				if ($("#sb").val()) sandboxes.unshift( $("#sb").val() );
				
				baseUrl += "v/" + $("#fhir-version").val();

				if (sandboxes.length) baseUrl += "/sb/" + sandboxes.join(",");
			
				var paramMap = {
					"launch-ehr": [
						["#patient", "patient"],
						["#encounter", "encounter"],
						["#auth-error", "auth_error"],
						["#user-prov", "user"]
					],
					"launch-prov": [
						["#launch-prov", "launch_prov"],
						["#patient", "patient"],
						["#encounter", "encounter"],
						["#auth-error", "auth_error"],
						["#prov-skip-login", "skip_login"], 
						["#prov-skip-auth", "skip_auth"], 
						["#user-prov", "user"]
					],
					"launch-pt": [
						["#launch-pt", "launch_pt"],
						["#auth-error", "auth_error"],
						["#pt-skip-login", "skip_login"],
						["#pt-skip-auth", "skip_auth"],
						["#user-pt", "patient"]
					]
				}

				var urlParams = {};
				$.each( paramMap[$("input[name=launch-type]:checked").attr("id")], function(i, param) {
					var val = $(param[0]).is(":checkbox,:radio") ? $(param[0]).is(":checked") : $(param[0]).val();
					if (val) urlParams[param[1]] = (val === true ? "1" : val);
				})

				var openUrl = baseUrl + "/fhir";
				var standaloneUrl = baseUrl + "/sim/" + btoa(JSON.stringify(urlParams)) + "/fhir";
				var appLaunchUrl = $("#launch-url").val();
				var ehrLaunchUrl = appLaunchUrl + "?" + 
					"iss=" +  window.encodeURIComponent(openUrl) +
					"&launch=" + btoa(JSON.stringify(urlParams));

				$("#open-url").text(openUrl);
				$("#ehr-launch-url").attr("href", ehrLaunchUrl);
				$("#standalone-launch-url").text(standaloneUrl);

			}


			function handleFormChange() {
				$(".launch").hide().filter("." + $("input[name=launch-type]:checked").attr("id")).show();
				$(".sb").hide().filter(".sb." + $("#fhir-version").val()).show();
				buildUrls();
				formToQs();
			}

			function init() {
				qsToForm();
				bindEventHandlers();
				handleFormChange();
				$("#loading").hide();
				$("#content").show();
			}

			init();

		</script>

	</body>
</html>